# Scanning

## Automated Enumeration Tools

The below tools can be used to automate the survey ad prviliege escalation process.  Reference the source documentation for usage of each tool.  If you plan to use these, run as many as you can as each each one offers different outputs and recommendations that others do not:

* [reonnoiter](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS)
       ```
       reconnoitre -t <IP_ADDR> -o <OUTPUT_DIRECTORY> --services
       ```
* [nmapAutomator](https://github.com/21y4d/nmapAutomator)
* sparta 
* unircorn scan
* onetowpunch 

Before scannig, ensure to update the nmap databse:
```
nmap --script-updatedb
```

<br/>

## Host Discovery

Ping sweep:
```
nmap -sP <TARGET_RANGE>
nmap -sn <TARGET_RANGE>

# ping sweep and send the the list of IPs that are up to a seperate file
nmap -sP <TARGETRANGE> | grep -B1 'Host is up' | egrep -o '([0-9]{1,3}\.){3}[0-9]{1,3}' > ips.txt

# ping sweep and print out only the ips, store in all formats
nmap <subnet> -sn -oA tnet | grep for | cut -d" " -f5
```
Discover a single host with an ICMP echo request, no port scan, and show packet details:
```
nmap 10.129.2.18 -sn -oA host -PE --packet-trace

# arp ping
nmap 10.129.2.18 -sn -oA host -PE --reason
```
Netdiscover is an active/passive ARP reconnaissance tool that uses the Address Resolution Protocol (ARP) to find live hosts on a local network:
```
netdiscover -r 10.11.1.0/24
```
### Port Scanning  

Nmap can be saved to a file with `-oA`.  Use the follwoing to convert XML to HTML so it can be viewed in a web browser:
```
xsltproc target.xml -o target.html

# open in web browser
firefox target.html
```

My preferred scan (all ports, no host discovery, versions, and default scripts, show status every 60 seconds and show ports as they comee up):
```
nmap -sC -sV -Pm -p- <IP_ADDRESS> --stats-every=60s -v
```

Single port:
```
nmap -Pn -p <port> <IP_ADDRESS>
nc -nzv <IP_ADDDRESS> <PORT>

# use all the scripts
nmap -Pn -A -p <port> <IP_ADDRESS>

```
Other nmap scans:
```
# TCP Connect
nmap -sT -Pn <IP_ADDRESS>

# TCP SYN (must use sudo)
nmap -sS -Pn <IP_ADDRESS>

# Aggressive
nmap -A -Pn <IP_ADDRESS>
```

Scan all ports on all target devices in a file:
```
nmap -sC -sV -Pn -p- -iL ips.txt

# disables port scanning
nmap -sn -oA tnet -iL hosts.lst | grep for | cut -d" " -f5
```
Version scan
```
sudo nmap 10.129.2.28 -Pn -n --disable-arp-ping --packet-trace -p 445 --reason  -sV
```
Using nmap scripting engine:
```
# use only default scripts
nmap 10.129.2.28 -p 80 -sC

# aggressive script will try multiple categories
nmap 10.129.2.28 -p 80 -A

# use a script category such as vuln (will catch more than -A)
nmap <target> --script <category>
```
You find scripts for specific services in the following locations:
* HTTP: ls -l /usr/share/nmap/scripts/http*
* SMTP: ls -l /usr/share/nmap/scripts/smtp*
* SMB: ls -l /usr/share/nmap/scripts/smb*
* MySQL: ls -l /usr/share/nmap/scripts/mysql*
* WordPress: ls -l /usr/share/nmap/scripts/http-wordpress*
* Drupal: ls -l /usr/share/nmap/scripts/http-drupal*
* Citrix: ls -l /usr/share/nmap/scripts/citrix*
* ls -l /usr/share/nmap/scripts/ftp*


#### Firewalls and IDS/IPS

packets with the ACK flag are often passed by the firewall because the firewall cannot determine whether the connection was first established from the external network or the internal network.
```
nmap 10.129.2.28 -p 21,22,25 -sA -Pn -n --disable-arp-ping --packet-trace  --max-retries 0 
```
Testing if only individual subnets would not have access to the server's specific services (results may change from filtered to open):
```
# basic scan
nmap 10.129.2.28 -n -Pn -p445 -O

# Scan using a different source IP address
nmap 10.129.2.28 -n -Pn -p 445 -O -S 10.129.2.200 -e tun0  --max-retries 0 
```
If there is a firewall You will we get the RST flag and the port will show as unfiltered

cases in which administrators block specific subnets from different regions using an IPS, use decoys to Generates five random IP addresses that indicates the source IP the connection comes from:
```
nmap 10.129.2.28 -p 80 -sS -Pn -n --disable-arp-ping --packet-trace -D RND:5  --max-retries 0 
```
DNS Proxying: the company's DNS servers are usually more trusted than those from the Internet, so attempt to change the source port to 53:
```
nmap 10.129.2.28 -p50000 -sS -Pn -n --disable-arp-ping --packet-trace --source-port 53  --max-retries 0 

# verify results by connecting to open ports (must use sudo for this functionality)
sudo ncat -nv --source-port 53 10.129.2.28 50000
```
#### UDP Scanning 

```
# top 100
sudo nmap 10.129.2.28 -F -sU

# one port, provide reason
nmap 10.129.2.28 -sU -Pn -n --disable-arp-ping --packet-trace -p 137 --reason
```

Metasploit SYN scan
```
msf > db_nmap -sS -n <Target_IP> -p 0-65535
```

Banner grabbing:
```
nc -nv <IP_ADDDRESS> <PORT>
nmap -sV --script=banner -p <port> <ip>
```

list nmap scripts:


unicornscan
massscan

add to services:


For timing variations, retries, tempo, refer to https://nmap.org/book/man-performance.html




### DNS Enumeration 

The information retrieved during DNS enumeration will consist of details about names servers and IP addresses of potential targets (such as mail servers, sub-domains etc).

Gather general information about the domain such as the registrar, domain owner, their contact information and the DNS server used:
```
# retrieve all DNS records
dig any inlanefreight.com

# if you dont have the resolution in /etc/resolv.conf
dig any inlanefreight.com @<IP>

whois <DOMAIN>

# determine a target's nameservers
host -t ns google.com

# NS query
dig ns inlanefreight.htb @10.129.14.128

# version
dig CH TXT version.bind 10.129.120.85
```
Use 'nslookup' for querying the domain name system in order to obtain DNS records (IP Address):
```
nslookup <DOMAIN>

# query a specific record
nslookup -type=<RECORD> <DOMAIN>

# mail exchange example
nslookup -type=mx google.com

# lookup but specify DNS server to use
nslookup -type=any google.com 8.8.8.8
```
Resolce hostname to IP address:
```
host <DOMAIN>
```
View local DNS configuration on target:
```
# local DNS configuration
cat /etc/bind/named.conf.local

# zone file
/etc/bind/db.domain.com

# reverse name resolution zone file
/etc/bind/db.10.129.14
```
Zone transfer refers to the transfer of zones to another server in DNS, which generally happens over TCP port 53. This procedure is abbreviated Asynchronous Full Transfer Zone (AXFR).
```
dig axfr inlanefreight.htb @10.129.14.128

# internal zone transfer
dig axfr internal.inlanefreight.htb @10.129.14.128
```
Brute Force possible host names:
```
for sub in $(cat /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt);do dig $sub.inlanefreight.htb @10.129.14.128 | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

dnsenum --dnsserver 10.129.14.128 --enum -p 0 -s 0 -o subdomains.txt -f /opt/useful/SecLists/Discovery/DNS/subdomains-top1million-110000.txt inlanefreight.htb
```

### Domain Enumerations

certificate includes more than just a subdomain, and this means that the certificate is used for several domains, and these are most likely still active.

Use crt.sh to view logging of all digital certificates issued by a certificate authority in audit-proof logs. 
```
curl -s https://crt.sh/\?q\=inlanefreight.com\&output\=json | jq .

# filter for uniqe subsomains
curl -s https://crt.sh/\?q\=inlanefreight.com\&output\=json | jq . | grep name | cut -d":" -f2 | grep -v "CN=" | cut -d'"' -f2 | awk '{gsub(/\\n/,"\n");}1;' | sort -u
```
Based on the list of subdomains, identify which have publically accessible subdomains:
```
for i in $(cat subdomainlist);do host $i | grep "has address" | grep inlanefreight.com | cut -d" " -f1,4;done
```
Use shodan to search for ports exposed on the internet
```
for i in $(cat subdomainlist);do host $i | grep "has address" | grep inlanefreight.com | cut -d" " -f4 >> ip-addresses.txt;done
$ for i in $(cat ip-addresses.txt);do shodan host $i;done
```



